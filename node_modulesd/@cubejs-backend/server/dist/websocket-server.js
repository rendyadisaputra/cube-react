"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketServer = void 0;
const ws_1 = __importDefault(require("ws"));
const crypto_1 = __importDefault(require("crypto"));
const util_1 = __importDefault(require("util"));
class WebSocketServer {
    constructor(serverCore, options = {}) {
        this.serverCore = serverCore;
        this.options = options;
        this.subscriptionsTimer = null;
        this.wsServer = null;
        this.serverCore = serverCore;
    }
    initServer(server) {
        this.wsServer = new ws_1.default.Server({
            server,
            path: this.options.webSocketsBasePath,
        });
        const connectionIdToSocket = {};
        const subscriptionServer = this.serverCore.initSubscriptionServer((connectionId, message) => {
            if (!connectionIdToSocket[connectionId]) {
                throw new Error(`Socket for ${connectionId} is not found found`);
            }
            connectionIdToSocket[connectionId].send(JSON.stringify(message));
        });
        this.wsServer.on('connection', (ws) => {
            const connectionId = crypto_1.default.randomBytes(8).toString('hex');
            connectionIdToSocket[connectionId] = ws;
            ws.on('message', async (message) => {
                await subscriptionServer.processMessage(connectionId, message);
            });
            ws.on('close', async () => {
                await subscriptionServer.disconnect(connectionId);
            });
            ws.on('error', async () => {
                await subscriptionServer.disconnect(connectionId);
            });
        });
        this.subscriptionsTimer = setInterval(async () => {
            await subscriptionServer.processSubscriptions();
        }, this.options.processSubscriptionsInterval || 5 * 1000);
    }
    async close() {
        if (this.wsServer) {
            const close = util_1.default.promisify(this.wsServer.close.bind(this.wsServer));
            await close();
        }
        if (this.subscriptionsTimer) {
            clearInterval(this.subscriptionsTimer);
        }
    }
}
exports.WebSocketServer = WebSocketServer;
//# sourceMappingURL=websocket-server.js.map